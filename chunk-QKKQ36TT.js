import{a as le,b as se}from"./chunk-P64JN6AO.js";import{b as Y,c as Z}from"./chunk-OGSC24V2.js";import{j as ge}from"./chunk-4LRKX244.js";import{a as oe,b as ae}from"./chunk-PWJZ2LNL.js";import{b as L,e as me,f as pe}from"./chunk-SMABRFWC.js";import{b as K,c as Q,g as X,j as re}from"./chunk-2KVVKINI.js";import{B as F,E as R,F as O,K as j,N as U,O as $,P as W,Q as z,S as J,U as H,V as _e,W as ve,X as Ee,Y as ye,z as G}from"./chunk-OC4T4DRE.js";import{a as he,b as xe}from"./chunk-ZZPVTA7Y.js";import{b as q}from"./chunk-XYN5C5AP.js";import{a as Ce}from"./chunk-JPTBIBXE.js";import"./chunk-LKTWXCPZ.js";import{Ea as fe,h as D,i as P,n as B,sa as ee,ta as te,va as ie,wa as ne,xa as de,ya as ue,za as ce}from"./chunk-4THFQO72.js";import{Ab as y,Mc as N,Ob as f,Pb as n,Qb as i,Rb as g,Vb as A,Wb as T,Yb as w,ac as E,cb as c,cc as _,ob as S,pa as h,qa as x,qc as l,rc as M,ub as V,za as I}from"./chunk-XRA3D6DW.js";import{m as C}from"./chunk-SIIEGW5O.js";function Fe(a,d){a&1&&(n(0,"div",4),g(1,"mat-progress-spinner",5),i())}function ke(a,d){if(a&1&&(n(0,"mat-option",30),l(1),i()),a&2){let s=d.$implicit;f("value",s.value),c(),M(s.viewValue)}}function be(a,d){if(a&1){let s=w();A(0),n(1,"div",31)(2,"div")(3,"strong"),l(4,"Code d'acc\xE8s actuel:"),i(),n(5,"span",32),l(6),i()(),n(7,"div")(8,"button",33),E("click",function(){h(s);let e=_(2);return x(e.regenerateToken())}),l(9,"Reg\xE9n\xE9rer le code"),i()()(),T()}if(a&2){let s=_(2);c(6),M(s.currentToken()),c(2),f("disabled",s.loading())}}function Se(a,d){if(a&1){let s=w();A(0),n(1,"div",34),l(2,"Aucun code d'acc\xE8s g\xE9n\xE9r\xE9 pour cette famille."),i(),n(3,"div")(4,"button",33),E("click",function(){h(s);let e=_(2);return x(e.regenerateToken())}),l(5,"G\xE9n\xE9rer le code"),i()(),T()}if(a&2){let s=_(2);c(4),f("disabled",s.loading())}}function we(a,d){a&1&&(n(0,"mat-error"),l(1,"Le pr\xE9nom est requis."),i())}function Ie(a,d){a&1&&(n(0,"mat-error"),l(1,"Le pr\xE9nom ne peut pas d\xE9passer 100 caract\xE8res."),i())}function Me(a,d){a&1&&(n(0,"mat-error"),l(1,"Le nom est requis."),i())}function Ae(a,d){a&1&&(n(0,"mat-error"),l(1,"Le nom ne peut pas d\xE9passer 100 caract\xE8res."),i())}function Te(a,d){a&1&&(n(0,"mat-error"),l(1,"Format d'email invalide."),i())}function Ve(a,d){a&1&&(n(0,"mat-error"),l(1,"L'email ne peut pas d\xE9passer 255 caract\xE8res."),i())}function Ne(a,d){if(a&1){let s=w();n(0,"div",35)(1,"div",36)(2,"div",7)(3,"div",37)(4,"mat-form-field",9)(5,"mat-label"),l(6,"Pr\xE9nom"),i(),g(7,"input",38),y(8,we,2,0,"mat-error",2)(9,Ie,2,0,"mat-error",2),i()(),n(10,"div",37)(11,"mat-form-field",9)(12,"mat-label"),l(13,"Nom"),i(),g(14,"input",39),y(15,Me,2,0,"mat-error",2)(16,Ae,2,0,"mat-error",2),i()(),n(17,"div",37)(18,"mat-form-field",9)(19,"mat-label"),l(20,"Email"),i(),g(21,"input",40),y(22,Te,2,0,"mat-error",2)(23,Ve,2,0,"mat-error",2),i()()(),n(24,"div",7)(25,"div",41)(26,"mat-checkbox",42),l(27,"R\xE9ception"),i(),n(28,"mat-checkbox",43),l(29,"Repas"),i(),n(30,"mat-checkbox",44),l(31,"Soir\xE9e"),i()(),n(32,"div",45)(33,"mat-radio-button",46),E("change",function(){let e,r=h(s).index,o=_(2);return x((e=o.form.get("personne_principale"))==null?null:e.setValue((e=o.persons.at(r).get("id"))==null?null:e.value))}),l(34," Personne principale "),i()()()(),n(35,"div",47)(36,"button",48),E("click",function(){let e=h(s).index,r=_(2);return x(r.removePerson(e))}),n(37,"mat-icon"),l(38,"delete"),i()()()()}if(a&2){let s,t,e,r,o,p,v,m,u=d.$implicit,k=d.index,b=_(2);f("formGroupName",k),c(8),f("ngIf",((s=u.get("prenom"))==null?null:s.hasError("required"))&&((s=u.get("prenom"))==null?null:s.touched)),c(),f("ngIf",((t=u.get("prenom"))==null?null:t.hasError("maxlength"))&&((t=u.get("prenom"))==null?null:t.touched)),c(6),f("ngIf",((e=u.get("nom"))==null?null:e.hasError("required"))&&((e=u.get("nom"))==null?null:e.touched)),c(),f("ngIf",((r=u.get("nom"))==null?null:r.hasError("maxlength"))&&((r=u.get("nom"))==null?null:r.touched)),c(6),f("ngIf",((o=u.get("email"))==null?null:o.hasError("email"))&&((o=u.get("email"))==null?null:o.touched)),c(),f("ngIf",((p=u.get("email"))==null?null:p.hasError("maxlength"))&&((p=u.get("email"))==null?null:p.touched)),c(10),f("value",(v=b.persons.at(k).get("id"))==null?null:v.value)("checked",((m=b.persons.at(k).get("id"))==null?null:m.value)===((m=b.form.get("personne_principale"))==null?null:m.value))}}function De(a,d){if(a&1){let s=w();n(0,"div")(1,"form",6)(2,"div",7)(3,"div",8)(4,"mat-form-field",9)(5,"mat-label"),l(6,"Pays"),i(),n(7,"mat-select",10),y(8,ke,2,2,"mat-option",11),i()()(),n(9,"div",12)(10,"mat-form-field",9)(11,"mat-label"),l(12,"Rue"),i(),g(13,"input",13),i()(),n(14,"div",14)(15,"mat-form-field",9)(16,"mat-label"),l(17,"Num\xE9ro"),i(),g(18,"input",15),i()(),n(19,"div",14)(20,"mat-form-field",9)(21,"mat-label"),l(22,"Bo\xEEte"),i(),g(23,"input",16),i()(),n(24,"div",14)(25,"mat-form-field",9)(26,"mat-label"),l(27,"CP"),i(),g(28,"input",17),i()(),n(29,"div",14)(30,"mat-form-field",9)(31,"mat-label"),l(32,"Ville"),i(),g(33,"input",18),i()()(),n(34,"div",19)(35,"button",20),E("click",function(){h(s);let e=_();return x(e.saveFamille())}),l(36,"Sauvegarder famille"),i(),n(37,"button",21),E("click",function(){h(s);let e=_();return x(e.savePersons())}),l(38,"Sauvegarder personnes"),i(),n(39,"button",22),E("click",function(){h(s);let e=_();return x(e.saveAll())}),l(40,"Sauvegarder tout"),i()(),n(41,"div",23)(42,"mat-card",24),y(43,be,10,2,"ng-container",2)(44,Se,6,1,"ng-container",2),i()(),n(45,"h4",25),l(46,"Personnes"),i(),n(47,"div",26),y(48,Ne,39,9,"div",27),i(),n(49,"div",28)(50,"button",29),E("click",function(){h(s);let e=_();return x(e.addPerson())}),n(51,"mat-icon"),l(52,"add"),i()()()()()}if(a&2){let s=_();c(),f("formGroup",s.form),c(7),f("ngForOf",s.countries),c(35),f("ngIf",s.currentToken()),c(),f("ngIf",!s.currentToken()),c(4),f("ngForOf",s.persons.controls)}}function Pe(a,d){a&1&&(n(0,"div",49),l(1,"Famille introuvable."),i())}var ft=(()=>{let d=class d{constructor(t,e,r,o){this.route=t,this.ngSupabase=e,this.snackBar=r,this.fb=o,this.famille=I(null),this.loading=I(!1),this.currentToken=I(null),this.familyDisplayName=N(()=>{let p=this.famille();if(!p)return"Famille";let v=p.personne_principale;if(v&&Array.isArray(p.personnes)){let m=p.personnes.find(u=>u.id===v);if(m)return`Famille ${m.prenom} ${m.nom}`}if(Array.isArray(p.personnes)&&p.personnes.length>0){let m=p.personnes[0];return`Famille ${m.prenom} ${m.nom}`}return`Famille #${p.id}`}),this.form=this.fb.group({rue:[""],numero:[""],boite:[""],cp:[""],ville:[""],pays:[""],personne_principale:[null],persons:this.fb.array([])}),this.deletedPersonIds=[],this.countries=[{value:"France",viewValue:"France"},{value:"Belgique",viewValue:"Belgique"},{value:"Suisse",viewValue:"Suisse"},{value:"England",viewValue:"Angleterre"},{value:"Spain",viewValue:"Espagne"},{value:"Italy",viewValue:"Italie"}]}ngOnInit(){let t=Number(this.route.snapshot.paramMap.get("id"))||null;t&&this.loadFamille(t)}get persons(){return this.form.get("persons")}createPersonGroup(t){return this.fb.group({id:[t?.id||null],nom:[t?.nom||"",[F.required,F.maxLength(100)]],prenom:[t?.prenom||"",[F.required,F.maxLength(100)]],email:[t?.email||"",[F.email,F.maxLength(255)]],invite_reception:[!!t?.invite_reception],invite_repas:[!!t?.invite_repas],invite_soiree:[!!t?.invite_soiree]})}addPerson(t){let e=this.createPersonGroup(t);this.persons.push(e),this.persons.length===1&&!this.form.get("personne_principale")?.value&&t?.id&&this.form.get("personne_principale")?.setValue(t.id)}removePerson(t){if(this.persons.length<=1){this.snackBar.open("Une famille doit contenir au moins une personne","Fermer",{duration:5e3});return}let r=this.persons.at(t).get("id")?.value,o=this.form.get("personne_principale")?.value;if(r&&r===o&&this.form.get("personne_principale")?.setValue(null),r&&this.deletedPersonIds.push(r),this.persons.removeAt(t),this.persons.length===1&&!this.form.get("personne_principale")?.value){let p=this.persons.at(0).get("id")?.value;p&&this.form.get("personne_principale")?.setValue(p)}}loadFamille(t){return C(this,null,function*(){this.loading.set(!0);try{let r=yield this.ngSupabase.getClient().from("familles").select("*, personnes!personnes_famille_id_fkey(*)").eq("id",t).single();if(r.error)throw r.error;let o=r.data;if(this.famille.set(o),this.currentToken.set(o.login_token||null),this.form.patchValue({rue:o.rue||"",numero:o.numero||"",boite:o.boite||"",cp:o.cp||"",ville:o.ville||"",pays:o.pays||"Belgique",personne_principale:o.personne_principale||null}),this.persons.clear(),Array.isArray(o.personnes)){for(let p of o.personnes)this.addPerson(p);if(!o.personne_principale&&o.personnes.length>0){let p=o.personnes[0].id;p&&this.form.get("personne_principale")?.setValue(p)}}}catch(e){console.error("Erreur chargement famille",e),this.famille.set(null),this.snackBar.open("Erreur chargement famille","Fermer",{duration:5e3})}finally{this.loading.set(!1)}})}saveFamille(){return C(this,null,function*(){if(this.form.invalid){this.form.markAllAsTouched(),this.snackBar.open("Formulaire invalide","Fermer",{duration:3e3});return}this.loading.set(!0);try{let t=this.ngSupabase.getClient(),e=this.famille()?.id;if(!e)throw new Error("ID famille manquant");let r={rue:this.form.value.rue||null,numero:this.form.value.numero||null,boite:this.form.value.boite||null,cp:this.form.value.cp||null,ville:this.form.value.ville||null,pays:this.form.value.pays||null,personne_principale:this.form.value.personne_principale||null},o=yield t.from("familles").update(r).eq("id",e);if(o.error)throw o.error;this.snackBar.open("Famille mise \xE0 jour","Fermer",{duration:3e3}),yield this.loadFamille(e)}catch(t){console.error("Erreur update famille",t),this.snackBar.open("Erreur lors de la mise \xE0 jour","Fermer",{duration:5e3})}finally{this.loading.set(!1)}})}generateUniqueLoginToken(t){return C(this,null,function*(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let r=0;r<25;r++){let o="";for(let m=0;m<8;m++)o+=e[Math.floor(Math.random()*e.length)];let{data:p,error:v}=yield t.from("familles").select("id").eq("login_token",o).limit(1);if(v)throw new Error("Erreur v\xE9rification token: "+(v.message||JSON.stringify(v)));if(!p||p.length===0)return o}throw new Error("Impossible de g\xE9n\xE9rer un token unique apr\xE8s plusieurs tentatives")})}regenerateToken(){return C(this,null,function*(){let t=this.famille()?.id;if(t&&!(this.currentToken()&&!confirm(`R\xE9g\xE9n\xE9rer le code d'acc\xE8s ?
L'ancien ne sera plus valide.`))){this.loading.set(!0);try{let e=this.ngSupabase.getClient(),r=yield this.generateUniqueLoginToken(e),o=yield e.from("familles").update({login_token:r}).eq("id",t);if(o.error)throw o.error;this.currentToken.set(r),this.snackBar.open("Nouveau code: "+r,"Fermer",{duration:5e3}),yield this.loadFamille(t)}catch(e){console.error("Erreur r\xE9g\xE9n\xE9ration token",e),this.snackBar.open("Erreur r\xE9g\xE9n\xE9ration: "+(e?.message||String(e)),"Fermer",{duration:6e3})}finally{this.loading.set(!1)}}})}savePersons(){return C(this,null,function*(){if(this.persons.length===0){this.snackBar.open("Une famille doit contenir au moins une personne","Fermer",{duration:5e3});return}if(this.persons.controls.filter(e=>e.invalid).length>0){this.persons.controls.forEach(e=>e.markAllAsTouched()),this.snackBar.open("Veuillez corriger les erreurs dans les informations des personnes","Fermer",{duration:5e3});return}this.loading.set(!0);try{let e=this.ngSupabase.getClient(),r=this.famille()?.id;if(!r)throw new Error("ID famille manquant");let o=this.persons.controls.map(m=>{let u=m,k=u.get("id")?.value,b={nom:u.get("nom")?.value,prenom:u.get("prenom")?.value,email:u.get("email")?.value||null,invite_reception:!!u.get("invite_reception")?.value,invite_repas:!!u.get("invite_repas")?.value,invite_soiree:!!u.get("invite_soiree")?.value,famille_id:r};return k&&(b.id=k),b}),p=o.filter(m=>m.id),v=o.filter(m=>!m.id);if(p.length>0){let m=yield e.from("personnes").upsert(p,{onConflict:"id"}).select();if(m.error)throw m.error}if(v.length>0){let m=yield e.from("personnes").insert(v).select();if(m.error)throw m.error}if(this.deletedPersonIds.length>0){let m=yield e.from("personnes").delete().in("id",this.deletedPersonIds);if(m.error)throw m.error;this.deletedPersonIds=[]}this.snackBar.open("Personnes sauvegard\xE9es","Fermer",{duration:3e3}),yield this.loadFamille(r)}catch(e){console.error("Erreur save persons",e),this.snackBar.open("Erreur lors de la sauvegarde des personnes","Fermer",{duration:5e3})}finally{this.loading.set(!1)}})}saveAll(){return C(this,null,function*(){if(this.form.invalid){this.form.markAllAsTouched(),this.snackBar.open("Formulaire invalide","Fermer",{duration:3e3});return}if(this.persons.length===0){this.snackBar.open("Une famille doit contenir au moins une personne","Fermer",{duration:5e3});return}if(this.persons.controls.filter(e=>e.invalid).length>0){this.persons.controls.forEach(e=>e.markAllAsTouched()),this.snackBar.open("Veuillez corriger les erreurs dans les informations des personnes","Fermer",{duration:5e3});return}try{yield this.savePersons(),yield this.saveFamille(),this.snackBar.open("Famille et personnes sauvegard\xE9es avec succ\xE8s","Fermer",{duration:3e3})}catch(e){console.error("Erreur lors de la sauvegarde compl\xE8te",e),this.snackBar.open("Erreur lors de la sauvegarde compl\xE8te","Fermer",{duration:5e3})}})}};d.\u0275fac=function(e){return new(e||d)(S(q),S(Ce),S(Ee),S(J))},d.\u0275cmp=V({type:d,selectors:[["app-admin-famille-detail"]],decls:7,vars:4,consts:[[1,"cardWithShadow"],["class","d-flex justify-center p-24",4,"ngIf"],[4,"ngIf"],["class","p-16 text-muted",4,"ngIf"],[1,"d-flex","justify-center","p-24"],["mode","indeterminate"],[3,"formGroup"],[1,"row"],[1,"col-lg-6"],["appearance","outline",1,"w-100"],["formControlName","pays"],[3,"value",4,"ngFor","ngForOf"],[1,"col-lg-4"],["matInput","","formControlName","rue"],[1,"col-lg-2"],["matInput","","formControlName","numero"],["matInput","","formControlName","boite"],["matInput","","formControlName","cp"],["matInput","","formControlName","ville"],[1,"m-t-12","d-flex","gap-8"],["mat-flat-button","","color","primary","type","button",3,"click"],["mat-stroked-button","","color","accent","type","button",3,"click"],["mat-stroked-button","","color","primary","type","button",3,"click"],[1,"m-t-12"],[1,"p-12"],[1,"m-t-16"],["formArrayName","persons"],["class","person-item p-8 b-t-1 d-flex align-center",3,"formGroupName",4,"ngFor","ngForOf"],[1,"m-t-8"],["mat-mini-fab","","color","primary","type","button",3,"click"],[3,"value"],[1,"d-flex","align-items-center","justify-content-between"],[1,"f-w-600","m-l-4"],["mat-stroked-button","","color","warn","type","button",3,"click","disabled"],[1,"text-muted","m-t-8"],[1,"person-item","p-8","b-t-1","d-flex","align-center",3,"formGroupName"],[1,"flex-grow-1"],[1,"col-md-4"],["matInput","","formControlName","prenom"],["matInput","","formControlName","nom"],["matInput","","formControlName","email","type","email"],[1,"col-md-6"],["formControlName","invite_reception"],["formControlName","invite_repas"],["formControlName","invite_soiree"],[1,"col-md-6","text-right"],["name","personne_principale_group",3,"change","value","checked"],[1,"actions"],["mat-icon-button","","color","warn","aria-label","Supprimer personne",3,"click"],[1,"p-16","text-muted"]],template:function(e,r){e&1&&(n(0,"mat-card",0)(1,"mat-card-content")(2,"mat-card-title"),l(3),i(),y(4,Fe,2,0,"div",1)(5,De,53,5,"div",2)(6,Pe,2,0,"div",3),i()()),e&2&&(c(3),M(r.familyDisplayName()),c(),f("ngIf",r.loading()),c(),f("ngIf",!r.loading()&&r.famille()),c(),f("ngIf",!r.loading()&&!r.famille()))},dependencies:[B,D,P,H,j,G,R,O,U,z,$,W,fe,de,ce,ue,re,X,K,Q,ae,oe,pe,me,L,Z,Y,se,le,ge,ve,_e,ne,te,ie,ee,xe,he,ye],styles:[".cardWithShadow[_ngcontent-%COMP%]{padding:12px}"],changeDetection:0});let a=d;return a})();export{ft as AdminFamilleDetailComponent};
