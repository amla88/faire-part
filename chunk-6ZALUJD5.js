import{a as d}from"./chunk-ALS2BQDB.js";import{Mc as l,ea as u,ia as h,za as o}from"./chunk-ROP7NO4L.js";import{m as r}from"./chunk-SIIEGW5O.js";var m=(()=>{let t=class t{constructor(e){this.sb=e,this.supabase=this.sb.getClient(),this.session=o(null),this.user=l(()=>this.session()?.user??null),this.profile=o(null),this.isAdmin=l(()=>this.profile()?.role==="admin"),this.loading=o(!1),this.error=o(null),this.init()}init(){return r(this,null,function*(){try{let{data:e}=yield this.supabase.auth.getSession();this.session.set(e.session??null),e.session?.user&&(yield this.loadProfile()),this.supabase.auth.onAuthStateChange((i,s)=>r(this,null,function*(){this.session.set(s??null),s?.user?yield this.loadProfile():this.profile.set(null)}))}catch(e){this.error.set(e?.message||"Erreur d'initialisation de la session")}})}signIn(e,i){return r(this,null,function*(){this.loading.set(!0),this.error.set(null);try{let{data:s,error:n}=yield this.supabase.auth.signInWithPassword({email:e,password:i});if(n)throw n;return this.session.set(s.session??null),yield this.loadProfile(),{success:!0}}catch(s){let n=s?.message||"Identifiants invalides";return this.error.set(n),{success:!1,error:n}}finally{this.loading.set(!1)}})}signOut(){return r(this,null,function*(){yield this.supabase.auth.signOut(),this.session.set(null),this.profile.set(null)})}loadProfile(){return r(this,null,function*(){let e=this.session()?.user;if(!e){this.profile.set(null);return}try{let{data:i,error:s}=yield this.supabase.from("profiles").select("id, role").eq("id",e.id).maybeSingle();if(s){console.error("[AdminAuthService] Erreur lors du chargement du profil:",s),s.code==="42501"||s.message.includes("permission denied")?(console.warn("[AdminAuthService] Permissions manquantes - voir ADMIN_CONFIGURATION.md pour la configuration des tables"),this.error.set("Permissions insuffisantes. Veuillez configurer les tables profiles et leurs politiques RLS.")):this.error.set(`Erreur de profil: ${s.message}`),this.profile.set(null);return}i?(this.profile.set({id:i.id,role:i.role??"invite"}),this.error.set(null)):this.profile.set(null)}catch(i){console.error("[AdminAuthService] Exception lors du chargement du profil:",i),this.error.set("Erreur inattendue lors du chargement du profil"),this.profile.set(null)}})}};t.\u0275fac=function(i){return new(i||t)(h(d))},t.\u0275prov=u({token:t,factory:t.\u0275fac,providedIn:"root"});let a=t;return a})();export{m as a};
