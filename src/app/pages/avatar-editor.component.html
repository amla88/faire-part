<div class="page-wrapper">
  <mat-card>
    <mat-card-title>Éditeur d'avatar</mat-card-title>
    <mat-card-content>
      <div *ngIf="error" class="error">{{ error }}</div>
      <div *ngIf="!personneId" class="hint">Aucun invité sélectionné. Connecte-toi via le lien d'invitation.</div>
      <div *ngIf="personneId" class="grid">
        <div class="preview-box">
          <div class="canvas">
            <img *ngFor="let layer of previewLayers" [src]="layer.url" [alt]="layer.label" class="layer" />
          </div>
        </div>
        <div>
          <div *ngIf="personnes.length > 1" class="mb12 row">
            <mat-select [(ngModel)]="personneId" (selectionChange)="onPersonChange()" class="minw240">
              <mat-option *ngFor="let p of personnes" [value]="p.id">{{ p.prenom || '' }} {{ p.nom || '' }}</mat-option>
            </mat-select>
          </div>
          <div *ngFor="let cat of categories" class="cat">
            <div class="cat-header">
              <h4 class="m0">{{ cat.label }}</h4>
              <button mat-stroked-button *ngIf="selected[cat.id]" (click)="clear(cat.id)"><mat-icon>clear</mat-icon> Retirer</button>
            </div>
            <div class="tiles">
              <button mat-stroked-button *ngFor="let a of byCategory[cat.id] || []"
                      (click)="select(cat.id, a)"
                      [color]="isSelected(cat.id, a) ? 'primary' : undefined"
                      class="tile">
                <img [src]="urlFor(a)" alt="thumb" class="tile-img" />
                <small>{{ a.label }}</small>
              </button>
            </div>
          </div>
          <div class="actions">
            <button mat-raised-button color="primary" (click)="save()" [disabled]="saving">{{ saving ? 'Enregistrement…' : 'Enregistrer' }}</button>
            <button mat-stroked-button (click)="reload()" [disabled]="saving">Recharger</button>
            <button mat-stroked-button (click)="resetAll()" [disabled]="saving">Réinitialiser</button>
            <button mat-raised-button color="accent" (click)="exportPng()" [disabled]="exporting || previewLayers.length===0">{{ exporting ? 'Export…' : 'Exporter PNG' }}</button>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
