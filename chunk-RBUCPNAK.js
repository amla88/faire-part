import{a as oe,b as le}from"./chunk-M7LN65QY.js";import{b as Q,c as X}from"./chunk-G3F2VJY2.js";import{j as _e,p as ge,u as xe}from"./chunk-RLNM4WJ2.js";import{a as ne,b as re}from"./chunk-N2Q4NVWM.js";import{b as T,e as ae,f as me}from"./chunk-DCQGY5E7.js";import{b as H,c as J,g as K,j as ie}from"./chunk-EIMTKMSA.js";import{B as b,E as G,F as j,K as L,N as R,O,P as $,Q as U,S as z,U as W,V as ce,W as fe,X as Ee,Y as Fe,z as q}from"./chunk-BDQMN6JN.js";import{a as ve,b as he}from"./chunk-ELI3AYMP.js";import{b as B}from"./chunk-32H5EB4Z.js";import{a as ye}from"./chunk-ALS2BQDB.js";import"./chunk-LKTWXCPZ.js";import{Ea as ue,h as P,i as D,n as V,sa as Y,ta as Z,va as ee,wa as te,xa as se,ya as pe,za as de}from"./chunk-F7FO76QX.js";import{Ab as F,Mc as N,Ob as f,Pb as n,Qb as t,Rb as v,Yb as I,ac as y,cb as c,cc as h,ob as S,pa as x,qa as E,qc as l,rc as k,ub as A,za as w}from"./chunk-ROP7NO4L.js";import{m as M}from"./chunk-SIIEGW5O.js";function be(a,p){a&1&&(n(0,"div",4),v(1,"mat-progress-spinner",5),t())}function Ce(a,p){if(a&1&&(n(0,"mat-option",28),l(1),t()),a&2){let d=p.$implicit;f("value",d.value),c(),k(d.viewValue)}}function Se(a,p){a&1&&(n(0,"mat-error"),l(1,"Le pr\xE9nom est requis."),t())}function Me(a,p){a&1&&(n(0,"mat-error"),l(1,"Le pr\xE9nom ne peut pas d\xE9passer 100 caract\xE8res."),t())}function we(a,p){a&1&&(n(0,"mat-error"),l(1,"Le nom est requis."),t())}function Ie(a,p){a&1&&(n(0,"mat-error"),l(1,"Le nom ne peut pas d\xE9passer 100 caract\xE8res."),t())}function ke(a,p){a&1&&(n(0,"mat-error"),l(1,"Format d'email invalide."),t())}function Ae(a,p){a&1&&(n(0,"mat-error"),l(1,"L'email ne peut pas d\xE9passer 255 caract\xE8res."),t())}function Ne(a,p){if(a&1){let d=I();n(0,"div",29)(1,"div",30)(2,"div",7)(3,"div",31)(4,"mat-form-field",9)(5,"mat-label"),l(6,"Pr\xE9nom"),t(),v(7,"input",32),F(8,Se,2,0,"mat-error",2)(9,Me,2,0,"mat-error",2),t()(),n(10,"div",31)(11,"mat-form-field",9)(12,"mat-label"),l(13,"Nom"),t(),v(14,"input",33),F(15,we,2,0,"mat-error",2)(16,Ie,2,0,"mat-error",2),t()(),n(17,"div",31)(18,"mat-form-field",9)(19,"mat-label"),l(20,"Email"),t(),v(21,"input",34),F(22,ke,2,0,"mat-error",2)(23,Ae,2,0,"mat-error",2),t()()(),n(24,"div",7)(25,"div",35)(26,"mat-checkbox",36),l(27,"R\xE9ception"),t(),n(28,"mat-checkbox",37),l(29,"Repas"),t(),n(30,"mat-checkbox",38),l(31,"Soir\xE9e"),t()(),n(32,"div",39)(33,"mat-radio-button",40),y("change",function(){let e,r=x(d).index,o=h(2);return E((e=o.form.get("personne_principale"))==null?null:e.setValue((e=o.persons.at(r).get("id"))==null?null:e.value))}),l(34," Personne principale "),t()()()(),n(35,"div",41)(36,"button",42),y("click",function(){let e=x(d).index,r=h(2);return E(r.removePerson(e))}),n(37,"mat-icon"),l(38,"delete"),t()()()()}if(a&2){let d,i,e,r,o,u,_,s,m=p.$implicit,g=p.index,C=h(2);f("formGroupName",g),c(8),f("ngIf",((d=m.get("prenom"))==null?null:d.hasError("required"))&&((d=m.get("prenom"))==null?null:d.touched)),c(),f("ngIf",((i=m.get("prenom"))==null?null:i.hasError("maxlength"))&&((i=m.get("prenom"))==null?null:i.touched)),c(6),f("ngIf",((e=m.get("nom"))==null?null:e.hasError("required"))&&((e=m.get("nom"))==null?null:e.touched)),c(),f("ngIf",((r=m.get("nom"))==null?null:r.hasError("maxlength"))&&((r=m.get("nom"))==null?null:r.touched)),c(6),f("ngIf",((o=m.get("email"))==null?null:o.hasError("email"))&&((o=m.get("email"))==null?null:o.touched)),c(),f("ngIf",((u=m.get("email"))==null?null:u.hasError("maxlength"))&&((u=m.get("email"))==null?null:u.touched)),c(10),f("value",(_=C.persons.at(g).get("id"))==null?null:_.value)("checked",((s=C.persons.at(g).get("id"))==null?null:s.value)===((s=C.form.get("personne_principale"))==null?null:s.value))}}function Pe(a,p){if(a&1){let d=I();n(0,"div")(1,"form",6)(2,"div",7)(3,"div",8)(4,"mat-form-field",9)(5,"mat-label"),l(6,"Pays"),t(),n(7,"mat-select",10),F(8,Ce,2,2,"mat-option",11),t()()(),n(9,"div",12)(10,"mat-form-field",9)(11,"mat-label"),l(12,"Rue"),t(),v(13,"input",13),t()(),n(14,"div",14)(15,"mat-form-field",9)(16,"mat-label"),l(17,"Num\xE9ro"),t(),v(18,"input",15),t()(),n(19,"div",14)(20,"mat-form-field",9)(21,"mat-label"),l(22,"Bo\xEEte"),t(),v(23,"input",16),t()(),n(24,"div",14)(25,"mat-form-field",9)(26,"mat-label"),l(27,"CP"),t(),v(28,"input",17),t()(),n(29,"div",14)(30,"mat-form-field",9)(31,"mat-label"),l(32,"Ville"),t(),v(33,"input",18),t()()(),n(34,"div",19)(35,"button",20),y("click",function(){x(d);let e=h();return E(e.saveFamille())}),l(36,"Sauvegarder famille"),t(),n(37,"button",21),y("click",function(){x(d);let e=h();return E(e.savePersons())}),l(38,"Sauvegarder personnes"),t(),n(39,"button",22),y("click",function(){x(d);let e=h();return E(e.saveAll())}),l(40,"Sauvegarder tout"),t()(),n(41,"h4",23),l(42,"Personnes"),t(),n(43,"div",24),F(44,Ne,39,9,"div",25),t(),n(45,"div",26)(46,"button",27),y("click",function(){x(d);let e=h();return E(e.addPerson())}),n(47,"mat-icon"),l(48,"add"),t()()()()()}if(a&2){let d=h();c(),f("formGroup",d.form),c(7),f("ngForOf",d.countries),c(36),f("ngForOf",d.persons.controls)}}function De(a,p){a&1&&(n(0,"div",43),l(1,"Famille introuvable."),t())}var ft=(()=>{let p=class p{constructor(i,e,r,o,u){this.route=i,this.ngSupabase=e,this.dialog=r,this.snackBar=o,this.fb=u,this.famille=w(null),this.loading=w(!1),this.familyDisplayName=N(()=>{let _=this.famille();if(!_)return"Famille";let s=_.personne_principale;if(s&&Array.isArray(_.personnes)){let m=_.personnes.find(g=>g.id===s);if(m)return`Famille ${m.prenom} ${m.nom}`}if(Array.isArray(_.personnes)&&_.personnes.length>0){let m=_.personnes[0];return`Famille ${m.prenom} ${m.nom}`}return`Famille #${_.id}`}),this.form=this.fb.group({rue:[""],numero:[""],boite:[""],cp:[""],ville:[""],pays:[""],personne_principale:[null],persons:this.fb.array([])}),this.deletedPersonIds=[],this.countries=[{value:"France",viewValue:"France"},{value:"Belgique",viewValue:"Belgique"},{value:"Suisse",viewValue:"Suisse"},{value:"England",viewValue:"Angleterre"},{value:"Spain",viewValue:"Espagne"},{value:"Italy",viewValue:"Italie"}]}ngOnInit(){let i=Number(this.route.snapshot.paramMap.get("id"))||null;i&&this.loadFamille(i)}get persons(){return this.form.get("persons")}createPersonGroup(i){return this.fb.group({id:[i?.id||null],nom:[i?.nom||"",[b.required,b.maxLength(100)]],prenom:[i?.prenom||"",[b.required,b.maxLength(100)]],email:[i?.email||"",[b.email,b.maxLength(255)]],invite_reception:[!!i?.invite_reception],invite_repas:[!!i?.invite_repas],invite_soiree:[!!i?.invite_soiree]})}addPerson(i){let e=this.createPersonGroup(i);this.persons.push(e),this.persons.length===1&&!this.form.get("personne_principale")?.value&&i?.id&&this.form.get("personne_principale")?.setValue(i.id)}removePerson(i){if(this.persons.length<=1){this.snackBar.open("Une famille doit contenir au moins une personne","Fermer",{duration:5e3});return}let r=this.persons.at(i).get("id")?.value,o=this.form.get("personne_principale")?.value;if(r&&r===o&&this.form.get("personne_principale")?.setValue(null),r&&this.deletedPersonIds.push(r),this.persons.removeAt(i),this.persons.length===1&&!this.form.get("personne_principale")?.value){let u=this.persons.at(0).get("id")?.value;u&&this.form.get("personne_principale")?.setValue(u)}}loadFamille(i){return M(this,null,function*(){this.loading.set(!0);try{let r=yield this.ngSupabase.getClient().from("familles").select("*, personnes!personnes_famille_id_fkey(*)").eq("id",i).single();if(r.error)throw r.error;let o=r.data;if(this.famille.set(o),this.form.patchValue({rue:o.rue||"",numero:o.numero||"",boite:o.boite||"",cp:o.cp||"",ville:o.ville||"",pays:o.pays||"Belgique",personne_principale:o.personne_principale||null}),this.persons.clear(),Array.isArray(o.personnes)){for(let u of o.personnes)this.addPerson(u);if(!o.personne_principale&&o.personnes.length>0){let u=o.personnes[0].id;u&&this.form.get("personne_principale")?.setValue(u)}}}catch(e){console.error("Erreur chargement famille",e),this.famille.set(null),this.snackBar.open("Erreur chargement famille","Fermer",{duration:5e3})}finally{this.loading.set(!1)}})}saveFamille(){return M(this,null,function*(){if(this.form.invalid){this.form.markAllAsTouched(),this.snackBar.open("Formulaire invalide","Fermer",{duration:3e3});return}this.loading.set(!0);try{let i=this.ngSupabase.getClient(),e=this.famille()?.id;if(!e)throw new Error("ID famille manquant");let r={rue:this.form.value.rue||null,numero:this.form.value.numero||null,boite:this.form.value.boite||null,cp:this.form.value.cp||null,ville:this.form.value.ville||null,pays:this.form.value.pays||null,personne_principale:this.form.value.personne_principale||null},o=yield i.from("familles").update(r).eq("id",e);if(o.error)throw o.error;this.snackBar.open("Famille mise \xE0 jour","Fermer",{duration:3e3}),yield this.loadFamille(e)}catch(i){console.error("Erreur update famille",i),this.snackBar.open("Erreur lors de la mise \xE0 jour","Fermer",{duration:5e3})}finally{this.loading.set(!1)}})}savePersons(){return M(this,null,function*(){if(this.persons.length===0){this.snackBar.open("Une famille doit contenir au moins une personne","Fermer",{duration:5e3});return}if(this.persons.controls.filter(e=>e.invalid).length>0){this.persons.controls.forEach(e=>e.markAllAsTouched()),this.snackBar.open("Veuillez corriger les erreurs dans les informations des personnes","Fermer",{duration:5e3});return}this.loading.set(!0);try{let e=this.ngSupabase.getClient(),r=this.famille()?.id;if(!r)throw new Error("ID famille manquant");let o=this.persons.controls.map(s=>{let m=s,g=m.get("id")?.value,C={nom:m.get("nom")?.value,prenom:m.get("prenom")?.value,email:m.get("email")?.value||null,invite_reception:!!m.get("invite_reception")?.value,invite_repas:!!m.get("invite_repas")?.value,invite_soiree:!!m.get("invite_soiree")?.value,famille_id:r};return g&&(C.id=g),C}),u=o.filter(s=>s.id),_=o.filter(s=>!s.id);if(u.length>0){let s=yield e.from("personnes").upsert(u,{onConflict:"id"}).select();if(s.error)throw s.error}if(_.length>0){let s=yield e.from("personnes").insert(_).select();if(s.error)throw s.error}if(this.deletedPersonIds.length>0){let s=yield e.from("personnes").delete().in("id",this.deletedPersonIds);if(s.error)throw s.error;this.deletedPersonIds=[]}this.snackBar.open("Personnes sauvegard\xE9es","Fermer",{duration:3e3}),yield this.loadFamille(r)}catch(e){console.error("Erreur save persons",e),this.snackBar.open("Erreur lors de la sauvegarde des personnes","Fermer",{duration:5e3})}finally{this.loading.set(!1)}})}saveAll(){return M(this,null,function*(){if(this.form.invalid){this.form.markAllAsTouched(),this.snackBar.open("Formulaire invalide","Fermer",{duration:3e3});return}if(this.persons.length===0){this.snackBar.open("Une famille doit contenir au moins une personne","Fermer",{duration:5e3});return}if(this.persons.controls.filter(e=>e.invalid).length>0){this.persons.controls.forEach(e=>e.markAllAsTouched()),this.snackBar.open("Veuillez corriger les erreurs dans les informations des personnes","Fermer",{duration:5e3});return}try{yield this.savePersons(),yield this.saveFamille(),this.snackBar.open("Famille et personnes sauvegard\xE9es avec succ\xE8s","Fermer",{duration:3e3})}catch(e){console.error("Erreur lors de la sauvegarde compl\xE8te",e),this.snackBar.open("Erreur lors de la sauvegarde compl\xE8te","Fermer",{duration:5e3})}})}};p.\u0275fac=function(e){return new(e||p)(S(B),S(ye),S(ge),S(Ee),S(z))},p.\u0275cmp=A({type:p,selectors:[["app-admin-famille-detail"]],decls:7,vars:4,consts:[[1,"cardWithShadow"],["class","d-flex justify-center p-24",4,"ngIf"],[4,"ngIf"],["class","p-16 text-muted",4,"ngIf"],[1,"d-flex","justify-center","p-24"],["mode","indeterminate"],[3,"formGroup"],[1,"row"],[1,"col-lg-6"],["appearance","outline",1,"w-100"],["formControlName","pays"],[3,"value",4,"ngFor","ngForOf"],[1,"col-lg-4"],["matInput","","formControlName","rue"],[1,"col-lg-2"],["matInput","","formControlName","numero"],["matInput","","formControlName","boite"],["matInput","","formControlName","cp"],["matInput","","formControlName","ville"],[1,"m-t-12","d-flex","gap-8"],["mat-flat-button","","color","primary","type","button",3,"click"],["mat-stroked-button","","color","accent","type","button",3,"click"],["mat-stroked-button","","color","primary","type","button",3,"click"],[1,"m-t-16"],["formArrayName","persons"],["class","person-item p-8 b-t-1 d-flex align-center",3,"formGroupName",4,"ngFor","ngForOf"],[1,"m-t-8"],["mat-mini-fab","","color","primary","type","button",3,"click"],[3,"value"],[1,"person-item","p-8","b-t-1","d-flex","align-center",3,"formGroupName"],[1,"flex-grow-1"],[1,"col-md-4"],["matInput","","formControlName","prenom"],["matInput","","formControlName","nom"],["matInput","","formControlName","email","type","email"],[1,"col-md-6"],["formControlName","invite_reception"],["formControlName","invite_repas"],["formControlName","invite_soiree"],[1,"col-md-6","text-right"],["name","personne_principale_group",3,"change","value","checked"],[1,"actions"],["mat-icon-button","","color","warn","aria-label","Supprimer personne",3,"click"],[1,"p-16","text-muted"]],template:function(e,r){e&1&&(n(0,"mat-card",0)(1,"mat-card-content")(2,"mat-card-title"),l(3),t(),F(4,be,2,0,"div",1)(5,Pe,49,3,"div",2)(6,De,2,0,"div",3),t()()),e&2&&(c(3),k(r.familyDisplayName()),c(),f("ngIf",r.loading()),c(),f("ngIf",!r.loading()&&r.famille()),c(),f("ngIf",!r.loading()&&!r.famille()))},dependencies:[V,P,D,W,L,q,G,j,R,U,O,$,ue,se,de,pe,ie,K,H,J,re,ne,me,ae,T,X,Q,le,oe,_e,fe,ce,te,Z,ee,Y,he,ve,xe,Fe],styles:[".cardWithShadow[_ngcontent-%COMP%]{padding:12px}"],changeDetection:0});let a=p;return a})();export{ft as AdminFamilleDetailComponent};
