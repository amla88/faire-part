import{b as y}from"./chunk-H6NXOTLM.js";import{a as h}from"./chunk-ALS2BQDB.js";import{ea as m,ja as f}from"./chunk-ROP7NO4L.js";import{m as p}from"./chunk-SIIEGW5O.js";var S=(()=>{let i=class i{constructor(){this.supabase=f(h),this.auth=f(y),this.oracleBaseUrl=this.resolveOracleBaseUrl()}uploadGuestPhoto(e){return p(this,null,function*(){if(!e)throw new Error("Aucun fichier fourni");if(!this.auth.getUser()?.famille_id)throw new Error("Utilisateur non authentifi\xE9");let{url:n,key:r}=this.resolveSupabaseConfig();if(!n||!r)throw new Error("Configuration Supabase manquante");let o=this.auth.getToken();if(!o)throw new Error("Token invit\xE9 manquant");let c=new FormData;c.append("file",e,e.name);let a=`${n.replace(/\/$/,"")}/functions/v1/upload-photo`,l=yield fetch(a,{method:"POST",headers:{Authorization:`Bearer ${r}`,apikey:r,"x-app-token":o},body:c}),u=null;try{u=yield l.json()}catch{}if(!l.ok){let s=u?.error||`\xC9chec de l'upload (HTTP ${l.status})`;throw new Error(s)}return u})}listFamilyPhotos(){return p(this,null,function*(){let e=this.auth.getUser(),t=this.auth.getToken();if(!e?.famille_id)throw new Error("Utilisateur non authentifi\xE9");if(!t)throw new Error("Jeton d'invitation introuvable");let{url:n,key:r}=this.resolveSupabaseConfig();if(!n||!r)throw new Error("Configuration Supabase manquante");let o=`${n.replace(/\/$/,"")}/functions/v1/list-photos`,c=yield fetch(o,{method:"POST",headers:{Authorization:`Bearer ${r}`,apikey:r,"x-app-token":t,"content-type":"application/json"},body:"{}"}),a=null;try{a=yield c.json()}catch{}if(!c.ok){let s=a?.error||"Impossible de r\xE9cup\xE9rer les photos";throw new Error(s)}let u=(Array.isArray(a?.items)?a.items:[]).map(s=>this.normalizeEdgePhoto(s)).filter(s=>!!s);return this.sortByDateDesc(u)})}resolveSupabaseConfig(){try{let e=window;if(e&&e.__env){let t=e.__env.SUPABASE_URL||e.__env.supabaseUrl||e.__env.SUPABASE_API_URL,n=e.__env.SUPABASE_ANON_KEY||e.__env.supabaseAnonKey||e.__env.SUPABASE_ANON;if(t&&n)return{url:t,key:n}}}catch{}try{let e=document.querySelector('meta[name="supabase-url"]')?.getAttribute("content")||void 0,t=document.querySelector('meta[name="supabase-anon-key"]')?.getAttribute("content")||void 0;if(e&&t)return{url:e,key:t}}catch{}try{let e=window,t=e.SUPABASE_URL||e.supabaseUrl,n=e.SUPABASE_ANON_KEY||e.supabaseAnonKey;if(t&&n)return{url:t,key:n}}catch{}return{}}normalizeEdgePhoto(e){if(!e)return null;let t=typeof e.key=="string"?e.key:typeof e.path=="string"?e.path:null;if(!t)return null;let n=typeof e.name=="string"&&e.name?e.name:t.split("/").pop()||t,r=typeof e.size=="number"?e.size:Number(e.size||0)||0,o=typeof e.lastModified=="string"&&e.lastModified?e.lastModified:typeof e.last_modified=="string"?e.last_modified:null,a=(typeof e.url=="string"&&e.url?e.url:null)||this.buildOracleUrl(t);return a?{key:t,name:n,url:a,size:r,lastModified:o}:null}sortByDateDesc(e){return[...e].sort((t,n)=>{let r=t.lastModified?new Date(t.lastModified).getTime():0;return(n.lastModified?new Date(n.lastModified).getTime():0)-r})}buildOracleUrl(e){if(!e)return null;let t=this.oracleBaseUrl;if(!t)return null;let n=t.replace(/\/+$/,""),r=e.split("/").map(o=>encodeURIComponent(o)).join("/");return`${n}/${r}`}resolveOracleBaseUrl(){let e=t=>{if(typeof t!="string")return null;let n=t.trim();return n?n.replace(/\/+$/,""):null};try{let t=window;if(t&&t.__env){let n=e(t.__env.ORACLE_PUBLIC_BASE_URL||t.__env.oraclePublicBaseUrl);if(n)return n}}catch{}try{let t=document.querySelector('meta[name="oracle-public-base-url"]')?.getAttribute("content"),n=e(t);if(n)return n}catch{}try{let t=window,n=e(t.ORACLE_PUBLIC_BASE_URL||t.oraclePublicBaseUrl);if(n)return n}catch{}return"https://axadzdd2ubpq.objectstorage.eu-paris-1.oci.customer-oci.com/n/axadzdd2ubpq/b/assets-mariage/o"}};i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"});let d=i;return d})();export{S as a};
