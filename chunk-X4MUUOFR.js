import{b as z,c as K}from"./chunk-OGSC24V2.js";import{a as ee,b as te}from"./chunk-PWJZ2LNL.js";import{b as T,e as ie,f as ne}from"./chunk-SMABRFWC.js";import{b as W,c as H,g as J,j as Z}from"./chunk-2KVVKINI.js";import{B as y,E as G,F as O,K as q,N as j,O as D,P as L,Q as R,S as $,U,V as se,W as pe,X as de,Y as ue,z as B}from"./chunk-OC4T4DRE.js";import{a as ce}from"./chunk-JPTBIBXE.js";import"./chunk-LKTWXCPZ.js";import{Ca as le,Ea as me,h as P,i as A,n as V,ta as Q,va as X,wa as Y,xa as re,ya as oe,za as ae}from"./chunk-4THFQO72.js";import{Ab as u,Ob as s,Pb as e,Qb as t,Rb as c,Yb as N,ac as E,cb as m,cc as S,ob as C,pa as F,qa as w,qc as i,rc as x,sc as k,ub as I}from"./chunk-XRA3D6DW.js";import{m as M}from"./chunk-SIIEGW5O.js";function fe(o,l){if(o&1&&(e(0,"mat-option",25),i(1),t()),o&2){let p=l.$implicit;s("value",p.value),m(),x(p.viewValue)}}function ve(o,l){if(o&1&&(e(0,"mat-option",25),i(1),t()),o&2){let p=l.$implicit;s("value",p.value),m(),x(p.viewValue)}}function _e(o,l){o&1&&(e(0,"small"),i(1,"(personne principale)"),t())}function ge(o,l){o&1&&(e(0,"mat-error"),i(1,"Le nom est requis."),t())}function he(o,l){o&1&&(e(0,"mat-error"),i(1,"Le pr\xE9nom est requis."),t())}function be(o,l){o&1&&(e(0,"mat-error"),i(1,"Email invalide."),t())}function Ee(o,l){if(o&1){let p=N();e(0,"div",26)(1,"h3",27),i(2),u(3,_e,2,0,"small",28),t(),e(4,"div",29)(5,"div",30)(6,"mat-label",7),i(7,"Nom"),t(),e(8,"mat-form-field",8),c(9,"input",31),u(10,ge,2,0,"mat-error",28),t()(),e(11,"div",30)(12,"mat-label",7),i(13,"Pr\xE9nom"),t(),e(14,"mat-form-field",8),c(15,"input",32),u(16,he,2,0,"mat-error",28),t()(),e(17,"div",30)(18,"mat-label",7),i(19,"Email"),t(),e(20,"mat-form-field",8),c(21,"input",33),u(22,be,2,0,"mat-error",28),t()(),e(23,"div",6)(24,"mat-label",7),i(25,"Invit\xE9 pour"),t(),e(26,"div",34)(27,"mat-checkbox",35),i(28,"R\xE9ception"),t(),e(29,"mat-checkbox",36),i(30,"Repas"),t(),e(31,"mat-checkbox",37),i(32,"Soir\xE9e"),t()()()(),e(33,"div",38)(34,"button",39),E("click",function(){F(p);let a=S();return w(a.addPerson())}),e(35,"mat-icon"),i(36,"add"),t()(),e(37,"button",40),E("click",function(){let a=F(p).index,n=S();return w(n.removePerson(a))}),e(38,"mat-icon"),i(39,"remove"),t()()()()}if(o&2){let p,r,a,n=l.$implicit,d=l.index,v=S();s("formGroupName",d),m(2),k("Personne ",d+1," "),m(),s("ngIf",d===0),m(7),s("ngIf",((p=n.get("nom"))==null?null:p.invalid)&&((p=n.get("nom"))==null?null:p.touched)),m(6),s("ngIf",((r=n.get("prenom"))==null?null:r.invalid)&&((r=n.get("prenom"))==null?null:r.touched)),m(6),s("ngIf",((a=n.get("email"))==null?null:a.invalid)&&((a=n.get("email"))==null?null:a.touched)),m(15),s("disabled",v.persons.controls.length<=1)}}function Se(o,l){if(o&1&&(e(0,"div",41),i(1),t()),o&2){let p=S();m(),x(p.message)}}var We=(()=>{let l=class l{constructor(r,a,n){this.fb=r,this.ngSupabase=a,this.snackBar=n,this.countries=[{value:"France",viewValue:"France"},{value:"Belgique",viewValue:"Belgique"},{value:"Suisse",viewValue:"Suisse"},{value:"England",viewValue:"Angleterre"},{value:"Spain",viewValue:"Espagne"},{value:"Italy",viewValue:"Italie"}],this.form=this.fb.group({rue:[""],numero:[""],boite:[""],cp:[""],ville:[""],pays:["Belgique"],persons:this.fb.array([this.createPersonGroup()])}),this.loading=!1,this.message=""}generateUniqueLoginToken(r){return M(this,null,function*(){let a="ABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let n=0;n<25;n++){let d="";for(let h=0;h<8;h++)d+=a[Math.floor(Math.random()*a.length)];let{data:v,error:f}=yield r.from("familles").select("id").eq("login_token",d).limit(1);if(f)throw new Error("Erreur v\xE9rification token: "+(f.message||JSON.stringify(f)));if(!v||v.length===0)return d}throw new Error("Impossible de g\xE9n\xE9rer un token unique apr\xE8s plusieurs tentatives")})}createPersonGroup(){return this.fb.group({nom:["",y.required],prenom:["",y.required],email:["",[y.email]],invite_reception:[!0],invite_repas:[!0],invite_soiree:[!0]})}get persons(){return this.form.get("persons")}addPerson(){this.persons.push(this.createPersonGroup())}removePerson(r){this.persons.length<=1||this.persons.removeAt(r)}submit(){return M(this,null,function*(){if(this.form.invalid){this.form.markAllAsTouched();return}this.loading=!0,this.message="";try{let r=this.ngSupabase.getClient(),a={personne_principale:null,rue:this.form.value.rue||null,numero:this.form.value.numero||null,boite:this.form.value.boite||null,cp:this.form.value.cp||null,ville:this.form.value.ville||null,pays:this.form.value.pays||null},n=yield r.from("familles").insert(a).select("id");if(n.error)throw n.error;let d=n.data?.[0]?.id;if(!d)throw new Error("Impossible de r\xE9cup\xE9rer l'id de la famille");let v=this.persons.controls.map(b=>{let g=b;return{nom:g.value.nom,prenom:g.value.prenom,email:g.value.email||null,invite_reception:!!g.value.invite_reception,invite_repas:!!g.value.invite_repas,invite_soiree:!!g.value.invite_soiree,famille_id:d}}),f=yield r.from("personnes").insert(v).select("id");if(f.error)throw f.error;let h=f.data?.[0]?.id,_=null;if(h){_=yield this.generateUniqueLoginToken(r);let b=yield r.from("familles").update({personne_principale:h,login_token:_}).eq("id",d);if(b.error)throw b.error}this.message="Famille et personnes ajout\xE9es."+(_?` (code: ${_})`:"");try{this.snackBar.open("Famille et personnes ajout\xE9es."+(_?`
Code: ${_}`:""),"Fermer",{duration:6e3})}catch{}this.form.reset(),this.form.setControl("persons",this.fb.array([this.createPersonGroup()]))}catch(r){console.error(r),this.message="Erreur lors de l'insertion : "+(r?.message??r);try{this.snackBar.open("Erreur lors de l'insertion : "+(r?.message??""),"Fermer",{duration:6e3})}catch{}}finally{this.loading=!1}})}};l.\u0275fac=function(a){return new(a||l)(C($),C(ce),C(de))},l.\u0275cmp=I({type:l,selectors:[["app-admin-famille"]],decls:64,vars:8,consts:[[1,"p-24","admin-famille"],[1,"cardWithShadow","theme-card"],[1,"m-b-0"],[1,"b-t-1"],[3,"ngSubmit","formGroup"],[1,"row"],[1,"col-lg-6"],[1,"f-w-600","m-b-8","d-block"],["appearance","outline",1,"w-100"],["formControlName","pays"],[3,"value",4,"ngFor","ngForOf"],["matInput","","type","text","formControlName","rue","placeholder","Rue"],[1,"col-lg-3"],["matInput","","type","text","formControlName","numero","placeholder","Num\xE9ro"],["matInput","","type","text","formControlName","boite","placeholder","Bo\xEEte"],["matInput","","type","text","formControlName","cp","placeholder","CP"],["matInput","","type","text","formControlName","ville","placeholder","Ville"],[1,"m-t-12"],["mat-flat-button","","color","primary","type","submit",1,"m-r-8",3,"disabled"],["mat-stroked-button","","color","warn","type","button",3,"click"],[1,"cardWithShadow","theme-card","m-t-12"],[3,"formGroup"],["formArrayName","persons"],["class","person-item m-b-8 p-8 b-t-1",3,"formGroupName",4,"ngFor","ngForOf"],["class","mt-4",4,"ngIf"],[3,"value"],[1,"person-item","m-b-8","p-8","b-t-1",3,"formGroupName"],[1,"m-0"],[4,"ngIf"],[1,"row","m-t-8"],[1,"col-lg-4"],["matInput","","type","text","formControlName","nom","placeholder","Nom"],["matInput","","type","text","formControlName","prenom","placeholder","Pr\xE9nom"],["matInput","","type","email","formControlName","email","placeholder","Email"],[1,"checkbox-group"],["formControlName","invite_reception"],["formControlName","invite_repas"],["formControlName","invite_soiree"],[1,"m-t-8"],["mat-mini-fab","","color","primary","type","button","aria-label","Ajouter personne",3,"click"],["mat-mini-fab","","color","warn","type","button","aria-label","Supprimer personne",3,"click","disabled"],[1,"mt-4"]],template:function(a,n){a&1&&(e(0,"div",0)(1,"h2"),i(2,"Ajouter une famille (table familles)"),t(),e(3,"mat-card",1)(4,"mat-card-header")(5,"mat-card-title",2),i(6,"Famille"),t()(),e(7,"mat-card-content",3)(8,"form",4),E("ngSubmit",function(){return n.submit()}),e(9,"div",5)(10,"div",6)(11,"mat-label",7),i(12,"Pays"),t(),e(13,"mat-form-field",8)(14,"mat-select",9),u(15,fe,2,2,"mat-option",10),t()()(),e(16,"div",6)(17,"mat-label",7),i(18,"Rue"),t(),e(19,"mat-form-field",8),c(20,"input",11),t()(),e(21,"div",12)(22,"mat-label",7),i(23,"Num\xE9ro"),t(),e(24,"mat-form-field",8),c(25,"input",13),t()(),e(26,"div",12)(27,"mat-label",7),i(28,"Bo\xEEte"),t(),e(29,"mat-form-field",8),c(30,"input",14),t()(),e(31,"div",12)(32,"mat-label",7),i(33,"Code postal"),t(),e(34,"mat-form-field",8),c(35,"input",15),t()(),e(36,"div",12)(37,"mat-label",7),i(38,"Ville"),t(),e(39,"mat-form-field",8),c(40,"input",16),t()(),e(41,"div",6)(42,"mat-label",7),i(43,"Pays"),t(),e(44,"mat-form-field",8)(45,"mat-select",9),u(46,ve,2,2,"mat-option",10),t()()()(),e(47,"div",17)(48,"button",18),i(49),t(),e(50,"button",19),E("click",function(){return n.form.reset()}),i(51,"Annuler"),t()()()()(),e(52,"mat-card",20)(53,"mat-card-header")(54,"mat-card-title",2),i(55,"Personnes"),t()(),e(56,"mat-card-content",3)(57,"div",21)(58,"div",22),u(59,Ee,40,7,"div",23),t()(),e(60,"div",17)(61,"small"),i(62,"Minimum 1 personne obligatoire (personne principale). Vous pouvez en ajouter autant que n\xE9cessaire."),t()()()(),u(63,Se,2,1,"div",24),t()),a&2&&(m(8),s("formGroup",n.form),m(7),s("ngForOf",n.countries),m(31),s("ngForOf",n.countries),m(2),s("disabled",n.form.invalid||n.loading),m(),x(n.loading?"En cours...":"Ajouter"),m(8),s("formGroup",n.form),m(2),s("ngForOf",n.persons.controls),m(4),s("ngIf",n.message))},dependencies:[V,P,A,U,q,B,G,O,j,R,D,L,me,re,ae,le,oe,Z,J,W,H,te,ee,ne,ie,T,K,z,ue,Y,Q,X,pe,se],styles:[".admin-famille[_ngcontent-%COMP%]{padding:1rem}.admin-famille[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-weight:600}.admin-famille[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{cursor:pointer}"],changeDetection:0});let o=l;return o})();export{We as AdminFamilleComponent};
